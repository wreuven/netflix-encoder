<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1920 1080" font-family="'Segoe UI', system-ui, -apple-system, sans-serif">
  <defs>
    <linearGradient id="bgGrad" x1="0" y1="0" x2="0" y2="1">
      <stop offset="0%" stop-color="#0a0e17"/>
      <stop offset="100%" stop-color="#0d1117"/>
    </linearGradient>
    <linearGradient id="headerGrad" x1="0" y1="0" x2="1" y2="0">
      <stop offset="0%" stop-color="#0f3460"/>
      <stop offset="100%" stop-color="#533483"/>
    </linearGradient>
    <linearGradient id="fdGrad" x1="0" y1="0" x2="1" y2="0">
      <stop offset="0%" stop-color="#b71c1c"/>
      <stop offset="50%" stop-color="#f57f17"/>
      <stop offset="100%" stop-color="#76b900"/>
    </linearGradient>
    <filter id="shadow" x="-4%" y="-4%" width="108%" height="108%">
      <feDropShadow dx="2" dy="3" stdDeviation="4" flood-opacity="0.35"/>
    </filter>
    <marker id="arrowWhite" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#ccc"/>
    </marker>
    <marker id="arrowGreen" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#76b900"/>
    </marker>
    <marker id="arrowRed" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#ef5350"/>
    </marker>
    <marker id="arrowOrange" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#ffa726"/>
    </marker>
    <marker id="arrowCyan" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#4dd0e1"/>
    </marker>
    <marker id="arrowPurple" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#ce93d8"/>
    </marker>
  </defs>

  <!-- Background -->
  <rect width="1920" height="1080" fill="url(#bgGrad)"/>

  <!-- Header -->
  <rect x="0" y="0" width="1920" height="76" fill="url(#headerGrad)" opacity="0.9"/>
  <text x="960" y="50" text-anchor="middle" fill="#fff" font-size="37" font-weight="700" letter-spacing="1">1-GPU2GPU-Copy NVENC — Vulkan-CUDA Interop Architecture</text>

  <!-- ============================================ -->
  <!-- GPU DOMAIN                                    -->
  <!-- ============================================ -->
  <rect x="30" y="92" width="1860" height="590" rx="14" fill="#0d1420" stroke="#333" stroke-width="1.5" filter="url(#shadow)"/>
  <rect x="30" y="92" width="1860" height="4" rx="2" fill="#76b900" opacity="0.6"/>
  <text x="58" y="122" fill="#555" font-size="20" font-weight="600" letter-spacing="2">GPU MEMORY</text>

  <!-- ============================================ -->
  <!-- LEFT COLUMN: Entry point flow                 -->
  <!-- Center line at y=220                          -->
  <!-- ============================================ -->

  <!-- Next browser frame -->
  <rect x="46" y="170" width="190" height="100" rx="12" fill="#1e3a5f" stroke="#4fc3f7" stroke-width="2" filter="url(#shadow)"/>
  <text x="141" y="210" text-anchor="middle" fill="#4fc3f7" font-size="19" font-weight="700">Next Browser</text>
  <text x="141" y="236" text-anchor="middle" fill="#4fc3f7" font-size="19" font-weight="700">Frame</text>

  <!-- Arrow: frame → vkQueuePresentKHR -->
  <line x1="236" y1="220" x2="274" y2="220" stroke="#ce93d8" stroke-width="2.5" marker-end="url(#arrowPurple)"/>

  <!-- vkQueuePresentKHR -->
  <rect x="280" y="152" width="260" height="136" rx="12" fill="#1a1a2e" stroke="#ce93d8" stroke-width="2.5" filter="url(#shadow)"/>
  <text x="410" y="186" text-anchor="middle" fill="#ce93d8" font-size="21" font-weight="800">vkQueuePresentKHR</text>
  <text x="410" y="212" text-anchor="middle" fill="#9575cd" font-size="17">layer intercepts</text>
  <text x="410" y="236" text-anchor="middle" fill="#777" font-size="16">classify + copy + encode</text>
  <text x="410" y="260" text-anchor="middle" fill="#777" font-size="16">all in one call</text>

  <!-- Arrow: vkQueuePresentKHR → classify_frame -->
  <line x1="540" y1="220" x2="580" y2="220" stroke="#ffa726" stroke-width="2.5" marker-end="url(#arrowOrange)"/>

  <!-- classify_frame() decision diamond -->
  <g transform="translate(586, 142)">
    <polygon points="100,0 200,78 100,156 0,78" fill="#1a1a2e" stroke="#ffa726" stroke-width="2.5" filter="url(#shadow)"/>
    <text x="100" y="64" text-anchor="middle" fill="#ffa726" font-size="18" font-weight="700">classify_frame()</text>
    <text x="100" y="86" text-anchor="middle" fill="#999" font-size="15">damage rects</text>
    <text x="100" y="106" text-anchor="middle" fill="#999" font-size="15">+ video state</text>
  </g>

  <!-- SHM metadata input (below diamond, right of VIDEO_ONLY line) -->
  <rect x="710" y="326" width="156" height="56" rx="8" fill="#0d2137" stroke="#4dd0e1" stroke-width="1.5" stroke-dasharray="5,3"/>
  <text x="788" y="350" text-anchor="middle" fill="#4dd0e1" font-size="15" font-weight="600">SHM metadata</text>
  <text x="788" y="370" text-anchor="middle" fill="#78909c" font-size="14">damage + video</text>
  <line x1="718" y1="326" x2="690" y2="300" stroke="#4dd0e1" stroke-width="1.5" stroke-dasharray="4,3" marker-end="url(#arrowCyan)"/>

  <!-- ============================================ -->
  <!-- THREE BRANCHES from diamond                   -->
  <!-- Diamond tip-right at x=786, center y=220     -->
  <!-- Diamond tip-top at y=142, tip-bottom at y=298 -->
  <!-- ============================================ -->

  <!-- UNCHANGED (exits top → right) -->
  <path d="M 686,142 L 686,118 L 880,118" fill="none" stroke="#4caf50" stroke-width="2.5" marker-end="url(#arrowGreen)"/>
  <!-- pill on the horizontal segment -->
  <rect x="718" y="102" width="120" height="28" rx="14" fill="#1b5e20" stroke="#4caf50" stroke-width="1"/>
  <text x="778" y="121" text-anchor="middle" fill="#81c784" font-size="16" font-weight="700">UNCHANGED</text>
  <!-- destination box -->
  <rect x="888" y="98" width="240" height="54" rx="10" fill="#0d1a0d" stroke="#4caf50" stroke-width="2" stroke-dasharray="6,3"/>
  <text x="1008" y="121" text-anchor="middle" fill="#4caf50" font-size="20" font-weight="700">Zero GPU work</text>
  <text x="1008" y="143" text-anchor="middle" fill="#689f38" font-size="16">no copy, no encode (~22%)</text>

  <!-- CHANGED (exits right → enc1 pipeline) -->
  <!-- pill sits above the arrow, clear of destination box -->
  <rect x="786" y="192" width="86" height="24" rx="12" fill="#4a1515" stroke="#ef5350" stroke-width="1"/>
  <text x="829" y="209" text-anchor="middle" fill="#ef9a9a" font-size="15" font-weight="700">CHANGED</text>
  <line x1="786" y1="220" x2="870" y2="220" stroke="#ef5350" stroke-width="2.5" marker-end="url(#arrowRed)"/>

  <!-- VIDEO_ONLY (exits bottom → right → enc2 pipeline) -->
  <!-- pill sits above the horizontal segment -->
  <rect x="718" y="392" width="130" height="28" rx="14" fill="#4a3000" stroke="#ffa726" stroke-width="1"/>
  <text x="783" y="411" text-anchor="middle" fill="#ffcc80" font-size="15" font-weight="700">VIDEO_ONLY</text>
  <path d="M 686,298 L 686,432 L 870,432" fill="none" stroke="#ffa726" stroke-width="2.5" marker-end="url(#arrowOrange)"/>

  <!-- ============================================ -->
  <!-- ENCODER 1 PIPELINE (CHANGED) — center y=220  -->
  <!-- All boxes: 70px tall, generous width          -->
  <!-- ============================================ -->

  <!-- GPU Copy: full frame -->
  <rect x="876" y="185" width="215" height="70" rx="10" fill="#1e1e2e" stroke="#ef5350" stroke-width="2" filter="url(#shadow)"/>
  <text x="983" y="214" text-anchor="middle" fill="#ef9a9a" font-size="17" font-weight="700">vkCmdCopyImageToBuffer</text>
  <text x="983" y="238" text-anchor="middle" fill="#999" font-size="15">full frame → enc1_buf</text>

  <!-- Arrow -->
  <line x1="1091" y1="220" x2="1117" y2="220" stroke="#ef5350" stroke-width="2" marker-end="url(#arrowRed)"/>

  <!-- VkBuffer enc1 -->
  <rect x="1123" y="185" width="170" height="70" rx="10" fill="#1e1e2e" stroke="#b71c1c" stroke-width="2" filter="url(#shadow)"/>
  <text x="1208" y="214" text-anchor="middle" fill="#ef5350" font-size="18" font-weight="700">VkBuffer</text>
  <text x="1208" y="238" text-anchor="middle" fill="#999" font-size="15">enc1_buf  DEVICE_LOCAL</text>

  <!-- fd arrow -->
  <line x1="1293" y1="220" x2="1329" y2="220" stroke="#f57f17" stroke-width="2.5" marker-end="url(#arrowGreen)"/>
  <text x="1311" y="211" text-anchor="middle" fill="#f57f17" font-size="14" font-weight="600">fd</text>

  <!-- CUDA dev_ptr enc1 -->
  <rect x="1335" y="185" width="170" height="70" rx="10" fill="#1e2e1e" stroke="#76b900" stroke-width="2" filter="url(#shadow)"/>
  <text x="1420" y="214" text-anchor="middle" fill="#76b900" font-size="18" font-weight="700">CUDA dev_ptr</text>
  <text x="1420" y="238" text-anchor="middle" fill="#777" font-size="15">same physical memory</text>

  <!-- Arrow to NVENC -->
  <line x1="1505" y1="220" x2="1539" y2="220" stroke="#76b900" stroke-width="2.5" marker-end="url(#arrowGreen)"/>

  <!-- NVENC Encoder 1 -->
  <rect x="1545" y="177" width="210" height="86" rx="12" fill="#1a2e1a" stroke="#76b900" stroke-width="2.5" filter="url(#shadow)"/>
  <text x="1650" y="207" text-anchor="middle" fill="#76b900" font-size="21" font-weight="800">NVENC</text>
  <text x="1650" y="231" text-anchor="middle" fill="#aed581" font-size="16">Encoder 1 — full-frame</text>
  <text x="1650" y="251" text-anchor="middle" fill="#555" font-size="14">LTR 0, deblock ON</text>

  <!-- ============================================ -->
  <!-- ENCODER 2 PIPELINE (VIDEO_ONLY) — center y=432 -->
  <!-- ============================================ -->

  <!-- GPU Copy: region -->
  <rect x="876" y="397" width="215" height="70" rx="10" fill="#1e1e2e" stroke="#ffa726" stroke-width="2" filter="url(#shadow)"/>
  <text x="983" y="426" text-anchor="middle" fill="#ffcc80" font-size="17" font-weight="700">vkCmdCopyImageToBuffer</text>
  <text x="983" y="450" text-anchor="middle" fill="#999" font-size="15">region → enc2_buf (imageOffset)</text>

  <!-- Arrow -->
  <line x1="1091" y1="432" x2="1117" y2="432" stroke="#ffa726" stroke-width="2" marker-end="url(#arrowOrange)"/>

  <!-- VkBuffer enc2 -->
  <rect x="1123" y="397" width="170" height="70" rx="10" fill="#1e1e2e" stroke="#b71c1c" stroke-width="2" filter="url(#shadow)"/>
  <text x="1208" y="426" text-anchor="middle" fill="#ef5350" font-size="18" font-weight="700">VkBuffer</text>
  <text x="1208" y="450" text-anchor="middle" fill="#999" font-size="15">enc2_buf  DEVICE_LOCAL</text>

  <!-- fd arrow -->
  <line x1="1293" y1="432" x2="1329" y2="432" stroke="#f57f17" stroke-width="2.5" marker-end="url(#arrowGreen)"/>
  <text x="1311" y="423" text-anchor="middle" fill="#f57f17" font-size="14" font-weight="600">fd</text>

  <!-- CUDA dev_ptr enc2 -->
  <rect x="1335" y="397" width="170" height="70" rx="10" fill="#1e2e1e" stroke="#76b900" stroke-width="2" filter="url(#shadow)"/>
  <text x="1420" y="426" text-anchor="middle" fill="#76b900" font-size="18" font-weight="700">CUDA dev_ptr</text>
  <text x="1420" y="450" text-anchor="middle" fill="#777" font-size="15">same physical memory</text>

  <!-- Arrow to NVENC -->
  <line x1="1505" y1="432" x2="1539" y2="432" stroke="#76b900" stroke-width="2.5" marker-end="url(#arrowGreen)"/>

  <!-- NVENC Encoder 2 -->
  <rect x="1545" y="389" width="210" height="86" rx="12" fill="#1a2e1a" stroke="#76b900" stroke-width="2.5" filter="url(#shadow)"/>
  <text x="1650" y="419" text-anchor="middle" fill="#76b900" font-size="21" font-weight="800">NVENC</text>
  <text x="1650" y="443" text-anchor="middle" fill="#aed581" font-size="16">Encoder 2 — region</text>
  <text x="1650" y="463" text-anchor="middle" fill="#555" font-size="14">per-row slices, deblock OFF</text>

  <!-- ============================================ -->
  <!-- BITSTREAM OUTPUT — routed along right edge    -->
  <!-- Stays far right to avoid cutting through text -->
  <!-- ============================================ -->

  <path d="M 1755,263 L 1810,263 L 1810,540 Q 1810,560 1790,560 L 510,560 Q 490,560 490,580 L 490,620" fill="none" stroke="#4dd0e1" stroke-width="2" stroke-dasharray="6,3"/>
  <path d="M 1755,475 L 1800,475 L 1800,540" fill="none" stroke="#4dd0e1" stroke-width="2" stroke-dasharray="6,3"/>
  <text x="1820" y="410" fill="#4dd0e1" font-size="17" font-weight="600" transform="rotate(90,1820,410)">H.264 bitstream</text>

  <!-- ============================================ -->
  <!-- ANNOTATIONS (between pipelines, left side)    -->
  <!-- ============================================ -->

  <!-- GPU-internal copy annotation -->
  <rect x="46" y="500" width="470" height="50" rx="8" fill="none" stroke="#4caf50" stroke-width="1" stroke-dasharray="5,3"/>
  <text x="281" y="522" text-anchor="middle" fill="#81c784" font-size="16" font-weight="600">vkCmdCopyImageToBuffer: swapchain → device-local buffer</text>
  <text x="281" y="542" text-anchor="middle" fill="#689f38" font-size="15">GPU-to-GPU — pixels never leave VRAM</text>

  <!-- "Same physical memory" annotation -->
  <rect x="876" y="500" width="390" height="50" rx="8" fill="none" stroke="#f57f17" stroke-width="1.5" stroke-dasharray="5,3"/>
  <text x="1071" y="522" text-anchor="middle" fill="#f57f17" font-size="17" font-weight="600">VkBuffer + CUDA dev_ptr = same GPU memory</text>
  <text x="1071" y="542" text-anchor="middle" fill="#999" font-size="15">VK_KHR_external_memory_fd exports → CUDA imports</text>

  <!-- ============================================ -->
  <!-- FLOW SUMMARY BANNER                           -->
  <!-- ============================================ -->

  <rect x="46" y="572" width="1560" height="56" rx="8" fill="#0a0e17" stroke="#444" stroke-width="1"/>
  <text x="826" y="596" text-anchor="middle" fill="#aaa" font-size="17" font-weight="600">Chrome → vkQueuePresentKHR (intercepted) → classify_frame() → [UNCHANGED: skip | CHANGED/VIDEO_ONLY: GPU copy → fd → CUDA → NVENC] → bitstream → SHM</text>
  <text x="826" y="618" text-anchor="middle" fill="#689f38" font-size="16">All in one synchronous call — zero CPU pixel copies</text>

  <!-- ============================================ -->
  <!-- CPU / SHM DOMAIN                              -->
  <!-- ============================================ -->

  <rect x="30" y="730" width="1860" height="230" rx="14" fill="#0d1420" stroke="#333" stroke-width="1.5" filter="url(#shadow)"/>
  <rect x="30" y="730" width="1860" height="4" rx="2" fill="#0277bd" opacity="0.6"/>
  <text x="58" y="762" fill="#555" font-size="20" font-weight="600" letter-spacing="2">CPU / SHARED MEMORY</text>

  <!-- Bitstream arrow into CPU domain -->
  <path d="M 490,628 Q 490,680 420,700 L 320,730 L 320,784" fill="none" stroke="#4dd0e1" stroke-width="2" stroke-dasharray="6,3" marker-end="url(#arrowCyan)"/>

  <!-- SHM bitstream region -->
  <rect x="80" y="790" width="400" height="110" rx="10" fill="#0d2137" stroke="#0277bd" stroke-width="2" filter="url(#shadow)"/>
  <text x="280" y="822" text-anchor="middle" fill="#4fc3f7" font-size="21" font-weight="700">SHM Bitstream Region</text>
  <text x="280" y="846" text-anchor="middle" fill="#78909c" font-size="17">/dev/shm/chrome_frame_capture</text>
  <rect x="105" y="862" width="155" height="22" rx="4" fill="#1a3a5a" stroke="#ef5350" stroke-width="1"/>
  <text x="182" y="878" text-anchor="middle" fill="#ef9a9a" font-size="15">enc1: 1MB</text>
  <rect x="275" y="862" width="155" height="22" rx="4" fill="#1a3a5a" stroke="#ffa726" stroke-width="1"/>
  <text x="352" y="878" text-anchor="middle" fill="#ffcc80" font-size="15">enc2: 1MB</text>

  <!-- Arrow: SHM → Python -->
  <line x1="480" y1="845" x2="570" y2="845" stroke="#7c4dff" stroke-width="2" marker-end="url(#arrowWhite)"/>
  <text x="525" y="836" text-anchor="middle" fill="#888" font-size="16">read</text>

  <!-- Python -->
  <rect x="576" y="790" width="320" height="110" rx="10" fill="#1a1a2e" stroke="#7c4dff" stroke-width="2" filter="url(#shadow)"/>
  <text x="736" y="824" text-anchor="middle" fill="#b388ff" font-size="21" font-weight="700">Python (netflix_encoder.py)</text>
  <text x="736" y="848" text-anchor="middle" fill="#888" font-size="17">NAL post-processing only</text>
  <text x="736" y="870" text-anchor="middle" fill="#777" font-size="16">LTR0 rewrite, splice stitching</text>

  <!-- Arrow: Python → MKV -->
  <line x1="896" y1="845" x2="990" y2="845" stroke="#66bb6a" stroke-width="2" marker-end="url(#arrowGreen)"/>

  <!-- MKV output -->
  <rect x="996" y="790" width="220" height="110" rx="10" fill="#1a2e1a" stroke="#66bb6a" stroke-width="2" filter="url(#shadow)"/>
  <text x="1106" y="824" text-anchor="middle" fill="#a5d6a7" font-size="21" font-weight="700">VFR MKV</text>
  <text x="1106" y="848" text-anchor="middle" fill="#689f38" font-size="17">live_spliced.mkv</text>
  <text x="1106" y="870" text-anchor="middle" fill="#555" font-size="16">PyAV frame-by-frame</text>

  <!-- KEY box -->
  <rect x="1280" y="794" width="570" height="110" rx="12" fill="#0d1117" stroke="#f57f17" stroke-width="1.5" stroke-dasharray="8,4"/>
  <text x="1565" y="828" text-anchor="middle" fill="#f57f17" font-size="21" font-weight="700">KEY</text>
  <text x="1305" y="856" fill="#999" font-size="18">GPU buffer (device-local) → fd export → CUDA → NVENC</text>
  <text x="1305" y="882" fill="#4caf50" font-size="18">UNCHANGED: classify reads SHM only → zero GPU work</text>

</svg>
